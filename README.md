# Ручка для CI/CD

Данный сервер предназначен для доставки необходимых файлов на сервер и развертывания.

## Описание принципа работы

Сервер слушает порт `8080` с единственной ручкой `/secret`. На данную ручку можно отправить `POST` запрос, указав при
этом данные, которые необходимы для развертывания сервера.

### Данныне

На ручку отправляется форма:

| Название поля |   Тип    | Описание                                                                      | 
|:-------------:|:--------:|:------------------------------------------------------------------------------|
|   `secret`    | `string` | Токен, необходимый для подтверждения запроса                                  |
|    `entry`    |  `file`  | Файл с названием `entry.sh`, который будет инициировать развертывание сервера | 
|   `myFiles`   | `files`  | Массив файлов, которые необходимы для развертывания                           | 

Файлы `myFiles` и `entry.sh` попадают в одну директорию, после чего файл `entry.sh` запускается. После успешного
выполнения скрипта `entry.sh` с сервера возращается ответ в формате `json`:

```json
{
  "status": "ok"
}
```

### Пример запроса

```shell
curl --location 'http://localhost:8080/secret' \
  --form 'myFiles=@"/files/docker-compose.yml"' \
  --form 'myFiles=@"/files/otherFile"' \
  --form 'secret="123"' \
  --form 'entry=@"/files/entry.sh"'
```

> [Полноценный пример разврертывания](https://github.com/gaskeo/cicd-actions/)

## Установка

Для установки сервера на Ubuntu/Debian необходимо:

### Простая установка

1. Задать переменные окружения:

   | Название            | Описание                                                       |
   |:--------------------|:---------------------------------------------------------------|
   | `CD_SECRET`         | Токен, необходимый для проверки входящих запросов              |
   | `CD_USER_DATA_PATH` | Директория, в которую будут сохраняться пользовательские файлы | 

2. Скопировать и запустить файл [`cd-server.linux`](cd-server.linux). После чего сервер будет слушать порт `8080`.

### Установка в systemctl

1. Скопировать фалы [`install.sh`](install.sh), [`cd-server.linux`](cd-server.linux)
2. Запустить файл `install.sh`. После выполенния скрипта программа добавится в сервисы
3. Настроить переменные в файле конфигурации: `/etc/cd-server/conf.env`, определение переменных идентичны определениям
   из простой установки
4. Перезапустить systemctl и добавить сервис в автозагрузку, после чего он будет слушать порт `8080`:
    ```shell
    ./install.sh
    systemctl daemon-reload
    systemctl enable cd-server.service
    systemctl start cd-server.service
    ```

